[delayed_gcode PRINTER_SHUTDOWN_PREPARE]
gcode:
  {action_respond_info("Printer try to auto shutdown")}
  SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=RasperryPi_CoolingFan TARGET=0
  UPDATE_DELAYED_GCODE ID=PRINTER_SHUTDOWN DURATION=5

[delayed_gcode PRINTER_SHUTDOWN]
gcode:
  {% if (printer.idle_timeout.state == 'Printing') %}
    {action_respond_info("Auto shutdown stopped. Printing is active. No retry.")}
  {% elif (printer['extruder']['temperature'] | int > 50) %}
    {action_respond_info("Shutdown stopped. Nozzle temperature about 50 C. Retry in 60 seconds.")}
    M104 S0    ; Set target nozzle temperature to 0Â°C without waiting
    UPDATE_DELAYED_GCODE ID=PRINTER_SHUTDOWN DURATION=60
  {% else %}
     {action_call_remote_method("set_device_power", device="Printer", state="off")} #shutdown the printer
  {% endif %}