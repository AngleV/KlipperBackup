[gcode_macro CHECK_PRINTER_SHUTDOWN_STATUS]
gcode:
    {% set current_state = printer["gcode_macro PRINTER_SHUTDOWN_AFTER_PRINT"].printer_shutdown_after_print %}
    {action_respond_info("Auto shutdown is currently: " ~ ("ENABLED" if current_state else "DISABLED"))}


[delayed_gcode PRINTER_SHUTDOWN_PREPARE]
gcode:
  {action_respond_info("Printer try to auto shutdown")}
  UPDATE_DELAYED_GCODE ID=PRINTER_SHUTDOWN DURATION=5

[delayed_gcode PRINTER_SHUTDOWN]
gcode:
  {% if (printer.idle_timeout.state == 'Printing') %}
    {action_respond_info("Auto shutdown stopped. Printing is active. No retry.")}
  {% elif (printer['extruder']['temperature'] | int > 60) %}
    {action_respond_info("Shutdown stopped. Nozzle temperature above 60 C. Retry in 2 minutes...")}
    M104 S0    ; Set target nozzle temperature to 0Â°C without waiting
    UPDATE_DELAYED_GCODE ID=PRINTER_SHUTDOWN DURATION=120
  {% else %}
     {action_call_remote_method("set_device_power", device="Printer", state="off")} #shutdown the printer
  {% endif %}